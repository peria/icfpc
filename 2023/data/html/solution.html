<!DOCTYPE html>
<html lang="ja">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <script>
    function update(problem, solution) {
      document.getElementById('score').innerText = `Score: ${solution.score}`;
      drawCanvas(problem, solution);
      updateMusiciansTable(problem, solution);
    }

    function drawCanvas(problem, solution) {
      const canvas = document.getElementById('canvas');
      const context = canvas.getContext('2d');
      const STAGE_BASE_X = problem.stage_bottom_left[0];
      const STAGE_BASE_Y = problem.stage_bottom_left[1];
      const CANVAS_BASE_X = 50;
      const CANVAS_BASE_Y = 50;
      const OFFSET_X = CANVAS_BASE_X - STAGE_BASE_X;
      const OFFSET_Y = CANVAS_BASE_Y - STAGE_BASE_Y;

      canvas.width = problem.stage_width + CANVAS_BASE_X * 2;
      canvas.height = problem.stage_height + CANVAS_BASE_Y * 2;
      const max_abs_score = solution.musicians
        .map(x => Math.abs(x.score))
        .reduce((m, x) => Math.max(m, x), 0);

      // Paint stage
      context.fillStyle = "rgb(128, 255, 255)";
      context.fillRect(STAGE_BASE_X + OFFSET_X,
        STAGE_BASE_Y + OFFSET_Y,
        problem.stage_width,
        problem.stage_height);

      // Draw musicians
      solution.musicians.forEach(musician => {
        const score = Math.floor(musician.score * 256 / max_abs_score);
        const color = score < 0 ? `rgb(${-score}, 0, 0)` : `rgb(${score}, ${score}, ${score})`;
        const place = musician.placement;
        const x = place.x + OFFSET_X;
        const y = place.y + OFFSET_Y;
        context.fillStyle = color;
        context.beginPath();
        context.arc(x, y, 5, 0, 2 * Math.PI);
        context.fill();
        context.stroke();
      });

      // Draw room outline
      context.fillStyle = "rgb(0, 0, 128)";
      context.strokeRect(OFFSET_X,
        OFFSET_Y,
        problem.room_width,
        problem.room_height);
    }

    function updateMusiciansTable(problem, solution) {
      const inst_table = document.getElementById('instruments');
      let count = {};
      console.log(problem.musicians);
      problem.musicians.forEach(
        x => count[x] = (count[x] == undefined) ? 1 : (count[x] + 1));
      console.log(count);
      let html = '';
      for (var key in count) {
        html += `<tr><td>${key}</td><td>${count[key]}</td></tr>`;
      }
      inst_table.innerHTML = html;
    }

    window.onload = () => {
      const params = (new URL(window.location.href)).searchParams;
      const id = params.get("id");
      document.getElementById('id').innerText = "ID: " + id;
      const problem_url = '../problem/problem-' + id + '.json';
      const solution_url = '../solution/solution-' + id + '.json';
      Promise.all([
        fetch(problem_url).then(x => x.json()),
        fetch(solution_url).then(x => x.json())
      ])
        .then(xs => update(xs[0], xs[1]));
    };
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
</head>

<body>
  <section class="container">
    <div class="row">
      <h4 id="id" class="col s3"></h4>
      <h4 id="score" class="col s3"></h4>
    </div>
    <div class="row">
      <div class="col s6">
        <canvas id="canvas"></canvas>
      </div>
      <div class="col s6">
        <table class="table col s6">
          <thead>
            <caption>Musician</caption>
            <tr>
              <th>楽器</th>
              <th>人数</th>
            </tr>
          </thead>
          <tbody id="instruments"></tbody>
        </table>
      </div>
    </div>
  </section>
</body>

</html>